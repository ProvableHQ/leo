#!/usr/bin/env bash
set -euo pipefail

LEO_BIN=${1}
SNARKOS=${LEO_TEST_SNARKOS_PATH:-$(which snarkos 2>/dev/null || echo "")}
if [ -z "$SNARKOS" ]; then
    echo "Error: snarkos not found. Set LEO_TEST_SNARKOS_PATH or install snarkos on PATH." >&2
    exit 1
fi
STORAGE=$(mktemp -d)
# The test framework injects port ranges for all snarkOS port types.
REST_PORT=${LEO_DEVNET_REST_PORT}
NODE_PORT=${LEO_DEVNET_NODE_PORT}
BFT_PORT=${LEO_DEVNET_BFT_PORT}
PID=""

cleanup() {
    [ -n "$PID" ] && kill "$PID" 2>/dev/null && wait "$PID" 2>/dev/null
    rm -rf "$STORAGE"
}
trap cleanup EXIT

$LEO_BIN --disable-update-check devnet \
    --snarkos "$SNARKOS" \
    --num-clients 0 \
    --rest-port "$REST_PORT" \
    --node-port "$NODE_PORT" \
    --bft-port "$BFT_PORT" \
    --storage "$STORAGE" \
    --clear-storage \
    --yes \
    --verbosity 0 \
    >/dev/null 2>"$STORAGE/leo-devnet.log" &
PID=$!

# First, wait for the REST endpoint to become reachable (up to 120s).
ENDPOINT="http://127.0.0.1:${REST_PORT}/testnet/block/height/latest"
DEADLINE=$((SECONDS + 120))
REST_UP=false
while [ $SECONDS -lt $DEADLINE ]; do
    if ! kill -0 "$PID" 2>/dev/null; then
        echo "Leo devnet process died during startup" >&2
        cat "$STORAGE/leo-devnet.log" >&2
        for f in "$STORAGE"/.logs-*/*.log; do [ -f "$f" ] && echo "--- $f ---" >&2 && tail -50 "$f" >&2; done
        echo "Leo devnet failed"
        exit 1
    fi
    if curl -sf "$ENDPOINT" >/dev/null 2>&1; then
        REST_UP=true
        break
    fi
    sleep 2
done

if [ "$REST_UP" = false ]; then
    echo "Leo devnet REST endpoint never became reachable (PORT=$REST_PORT)" >&2
    cat "$STORAGE/leo-devnet.log" >&2
    for f in "$STORAGE"/.logs-*/*.log; do [ -f "$f" ] && echo "--- $f ---" >&2 && tail -50 "$f" >&2; done
    echo "Leo devnet failed"
    exit 1
fi

# Then wait for at least 1 block to be produced (confirms consensus is working).
DEADLINE=$((SECONDS + 180))
REACHED=false
while [ $SECONDS -lt $DEADLINE ]; do
    if ! kill -0 "$PID" 2>/dev/null; then
        echo "Leo devnet process died while waiting for blocks" >&2
        echo "Leo devnet failed"
        exit 1
    fi
    if HEIGHT=$(curl -sf "$ENDPOINT") && [ "$HEIGHT" -ge 1 ] 2>/dev/null; then
        REACHED=true
        break
    fi
    sleep 2
done

if [ "$REACHED" = false ]; then
    echo "Leo devnet did not produce blocks (PORT=$REST_PORT)" >&2
    cat "$STORAGE/leo-devnet.log" >&2
    for f in "$STORAGE"/.logs-*/*.log; do [ -f "$f" ] && echo "--- $f ---" >&2 && tail -50 "$f" >&2; done
    echo "Leo devnet timed out"
    exit 1
fi

echo "Leo devnet is producing blocks"

# Stop the devnet.
kill "$PID" 2>/dev/null && wait "$PID" 2>/dev/null
PID=""

# Clean devnet storage and report.
$LEO_BIN --disable-update-check devnet --clean-only --snarkos "$SNARKOS" --storage "$STORAGE" --yes >/dev/null 2>&1
echo "Leo devnet clean succeeded"
